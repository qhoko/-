Создание продвинутого выхода из песочницы AngularJS
Итак, вы узнали, как работает базовый выход из песочницы, но вы можете столкнуться с сайтами, которые более строги в отношении того, какие символы они разрешают. Например, сайт может запретить вам использовать двойные или одинарные кавычки. В этой ситуации вам нужно использовать такие функции, как String.fromCharCode()для генерации ваших символов. Хотя AngularJS предотвращает доступ к Stringконструктору внутри выражения, вы можете обойти это, используя вместо этого свойство конструктора строки. Очевидно, что для этого требуется строка, поэтому для построения такой атаки вам нужно будет найти способ создания строки без использования одинарных или двойных кавычек.

В стандартном побеге из песочницы вы бы использовали $eval()для выполнения вашей полезной нагрузки JavaScript, но в лабораторной работе ниже функция $eval()не определена. К счастью, orderByвместо этого мы можем использовать фильтр. Типичный синтаксис фильтра orderByследующий:

[123]|orderBy:'Some string'
Обратите внимание, что |оператор имеет другое значение, чем в JavaScript. Обычно это побитовая ORоперация, но в AngularJS она обозначает операцию фильтра. В коде выше мы отправляем массив [123] слева в orderByфильтр справа. Двоеточие обозначает аргумент для отправки в фильтр, который в данном случае является строкой. Фильтр orderByобычно используется для сортировки объекта, но он также принимает выражение, что означает, что мы можем использовать его для передачи полезной нагрузки.

Теперь у вас есть все необходимые инструменты для выполнения следующей лабораторной работы.

В этой лабораторной работе AngularJS используется необычным способом, при котором $evalфункция недоступна, и вы не сможете использовать какие-либо строки в AngularJS.

Для решения лабораторной работы выполните атаку с использованием межсайтового скриптинга, которая выйдет за рамки «песочницы» и выполнит alertфункцию, не используя $evalее.

1. Перейдите по следующему URL-адресу, заменив его YOUR-LAB-IDидентификатором вашей лаборатории:

https://YOUR-LAB-ID.web-security-academy.net/?search=1&toString().constructor.prototype.charAt%3d[].join;[1]|orderBy:toString().constructor.fromCharCode(120,61,97,108,101,114,116,40,49,41)=1

Эксплойт использует toString()для создания строки без использования кавычек. Затем он получает Stringпрототип и перезаписывает charAtфункцию для каждой строки. Это фактически нарушает песочницу AngularJS. Затем массив передается в фильтр orderBy. Затем мы задаем аргумент для фильтра, снова используя toString()для создания строки и Stringсвойства конструктора. Наконец, мы используем fromCharCodeметод, генерирующий нашу полезную нагрузку, преобразуя коды символов в строку x=alert(1). Поскольку charAtфункция была перезаписана, AngularJS разрешит этот код, где обычно он этого не делает.

Структура кода

&toString().constructor.prototype.charAt=[].join;

&: Этот символ обычно используется как разделитель в параметрах URL, но в данном случае может быть частью кода или контекста, в котором используется данный фрагмент.

toString(): Это метод, который вызывается на каком-то объекте. Вероятно, подразумевается метод toString объекта типа String или другого объекта, который содержит данный метод.

constructor: Доступ к конструктору объекта, который позволяет получить доступ к его прототипу.

prototype.charAt: Это переопределяет метод charAt прототипа строки. В данном случае он будет ссылаться на метод join.

[1]: Это массив, имеющий один элемент, равный 1.

[].join;: Это метод join пустого массива, который конкатенирует элементы массива в строку.
   Итак, данная строка кода настраивает charAt для объектов, использующих toString(), так что вызов charAt будет фактически вызывать метод join, что потенциально может быть использовано для манипуляции данными.

[1]|orderBy:toString().constructor.fromCharCode(120,61,97,108,101,114,116,40,49,41)=1

[1]: Указывает на массив с элементом 1, который, возможно, используется как часть какого-то логического выражения или как временная переменная.

|: Этот символ может быть интерпретирован как побитовая операция OR, но в данном контексте скорее всего он используется в какой-то специфической логике, связанной с обработкой данных.

orderBy:: Это, вероятно, часть какого-то объекта или структуры данных, возможно, из базы данных или массива, чтобы указать порядок сортировки.

toString().constructor.fromCharCode(...): Вызывает метод fromCharCode, который создает строку из указанных кодов символов Unicode. В данном случае коды 120, 61, 97, 108, 101, 114, 116, 40, 49, 41 соответствуют символам:

120: x

61: =

97: a

108: l

101: e

114: r

116: t

40: (

49: 1

41: )

Таким образом, вызов fromCharCode возвращает строку: "x=alert(1)".

=1: Далее происходит сравнение или присваивание, где предполагается, что вышеуказанное выражение должно быть равно истинному значению 1.
