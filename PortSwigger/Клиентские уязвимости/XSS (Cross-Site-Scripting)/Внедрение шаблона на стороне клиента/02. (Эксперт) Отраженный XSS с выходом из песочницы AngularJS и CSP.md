Как работает обход AngularJS CSP?
Обходы политики безопасности контента (CSP) работают аналогично стандартным выходам из песочницы, но обычно включают некоторую HTML-инъекцию. Когда режим CSP активен в AngularJS, он анализирует выражения шаблонов по-другому и избегает использования конструктора Function. Это означает, что стандартный выход из песочницы, описанный выше, больше не будет работать.

В зависимости от конкретной политики CSP будет блокировать события JavaScript. Однако AngularJS определяет собственные события, которые можно использовать вместо этого. Находясь внутри события, AngularJS определяет специальный $eventобъект, который просто ссылается на объект события браузера. Вы можете использовать этот объект для выполнения обхода CSP. В Chrome есть специальное свойство объекта, $event/eventназываемое path. Это свойство содержит массив объектов, которые вызывают выполнение события. Последнее свойство всегда является объектом window, который мы можем использовать для выполнения выхода из песочницы. Передавая этот массив фильтру orderBy, мы можем перечислить массив и использовать последний элемент ( windowобъект) для выполнения глобальной функции, например alert(). Следующий код демонстрирует это:

<input autofocus ng-focus="$event.path|orderBy:'[].constructor.from([1],alert)'">
Обратите внимание, что from()используется функция, которая позволяет преобразовать объект в массив и вызвать заданную функцию (указанную во втором аргументе) для каждого элемента этого массива. В этом случае мы вызываем функцию alert(). Мы не можем вызвать функцию напрямую, потому что песочница AngularJS проанализирует код и обнаружит, что windowобъект используется для вызова функции. Использование from()функции вместо этого эффективно скрывает windowобъект от песочницы, позволяя нам внедрить вредоносный код.

Обход CSP с помощью выхода из песочницы AngularJS
В следующей лабораторной работе используется ограничение длины, поэтому указанный выше вектор не будет работать. Чтобы использовать лабораторную работу, вам нужно придумать различные способы скрытия windowобъекта из песочницы AngularJS. Один из способов сделать это — использовать array.map()функцию следующим образом:

[1].map(alert)
map()принимает функцию в качестве аргумента и вызывает ее для каждого элемента массива. Это обойдет песочницу, поскольку ссылка на функцию alert()используется без явного указания window. Чтобы решить лабораторную работу, попробуйте различные способы выполнения alert()без срабатывания обнаружения AngularJS window.

В этой лабораторной работе используются CSP и AngularJS.

Чтобы решить лабораторную работу, выполните атаку с использованием межсайтового скриптинга, которая обойдет CSP, выйдет за пределы песочницы AngularJS и выдаст оповещения document.cookie.

1. Перейдите на сервер эксплойтов и вставьте следующий код, заменив его YOUR-LAB-IDидентификатором вашей лаборатории:

<script>
location='https://YOUR-LAB-ID.web-security-academy.net/?search=%3Cinput%20id=x%20ng-focus=$event.composedPath()|orderBy:%27(z=alert)(document.cookie)%27%3E#x';
</script>

2. Нажмите «Сохранить» и «Доставить эксплойт жертве».

Эксплойт использует ng-focusсобытие в AngularJS для создания события фокуса, обходящего CSP. Он также использует $event, которая является переменной AngularJS, ссылающейся на объект события. pathСвойство специфично для Chrome и содержит массив элементов, которые вызвали событие. Последний элемент в массиве содержит объект window.

Обычно |это побитовая операция ИЛИ в JavaScript, но в AngularJS она указывает на операцию фильтра, в данном случае фильтр orderBy. Двоеточие обозначает аргумент, который отправляется фильтру. В аргументе, вместо alertпрямого вызова функции, мы присваиваем его переменной z. Функция будет вызвана только тогда, когда orderByоперация достигнет windowобъекта в $event.pathмассиве. Это означает, что ее можно вызвать в области действия окна без явной ссылки на windowобъект, эффективно обходя проверку AngularJS window.

<input id=x ng-focus=$event.composedPath()|orderBy:'(z=alert)(document.cookie)'>#x';
Элементы кода

<input id=x:

Это HTML-элемент ввода с заданным идентификатором x. Элемент будет активирован (например, когда на него будет осуществлён фокус).

ng-focus:

Это директива AngularJS, которая привязывает событие фокуса (focus event) к определённому выражению. Здесь она указывает, что когда элемент получает фокус, выполняется код, указанный в директиве.

$event.composedPath():

Это метод, который возвращает путь события (event path). Он создаёт массив с объектами, представляющими элементы DOM, которые были затронуты событием. Этот метод используется для получения информации о том, что вызвало событие.

|orderBy:'(z=alert)(document.cookie)':

Это синтаксис AngularJS для применения фильтров. Фильтр orderBy обычно используется для сортировки массивов. Однако в данном случае происходит попытка внедрить код с помощью строки '(z=alert)(document.cookie)', что является попыткой внедрения JavaScript-кода, который может вызвать alert() и, возможно, раскрыть содержимое document.cookie.

#x';:

Присутствует в конце строки, что может указывать на попытку завершить строку или выполнить скрипт и выделяет наличие кода или параметра после основного выражения. Эта часть выглядит как фрагмент, возможно, для обезличивания или завершения выражения.
