Уязвимости, основанные на DOM
В этом разделе мы опишем, что такое DOM, объясним, как небезопасная обработка данных DOM может привести к появлению уязвимостей, и предложим, как можно предотвратить уязвимости, основанные на DOM, на ваших веб-сайтах.

Просмотреть все лаборатории уязвимостей на основе DOM
Что такое ДОМ?
Объектная модель документа (DOM) — это иерархическое представление элементов на странице в веб-браузере. Веб-сайты могут использовать JavaScript для манипулирования узлами и объектами DOM, а также их свойствами. Манипулирование DOM само по себе не является проблемой. Фактически, это неотъемлемая часть работы современных веб-сайтов. Однако JavaScript, который обрабатывает данные небезопасно, может позволить проводить различные атаки. Уязвимости на основе DOM возникают, когда веб-сайт содержит JavaScript, который принимает контролируемое злоумышленником значение, известное как источник, и передает его в опасную функцию, известную как приемник.

Уязвимости потока заражения
Многие уязвимости, связанные с DOM, можно отследить до проблем, связанных с тем, как клиентский код манипулирует данными, контролируемыми злоумышленником.

Что такое поток загрязнений?
Чтобы воспользоваться этими уязвимостями или минимизировать их, важно сначала ознакомиться с основами потока зараженных данных между источниками и приемниками.

Источники
Источник — это свойство JavaScript, которое принимает данные, которые потенциально контролируются злоумышленником. Примером источника является свойство, location.searchпоскольку оно считывает входные данные из строки запроса, что относительно просто для злоумышленника для контроля. В конечном счете, любое свойство, которое может контролироваться злоумышленником, является потенциальным источником. Это включает в себя ссылающийся URL (раскрытый строкой document.referrer), файлы cookie пользователя (раскрытый строкой document.cookie) и веб-сообщения.

Приемник
Приёмник — это потенциально опасная функция JavaScript или объект DOM, которые могут вызвать нежелательные эффекты, если в них передаются контролируемые злоумышленником данные. Например, функция eval()является приёмником, поскольку она обрабатывает переданный ей аргумент как JavaScript. Примером приёмника HTML является document.body.innerHTMLто, что он потенциально позволяет злоумышленнику внедрить вредоносный HTML и выполнить произвольный JavaScript.

По сути, уязвимости на основе DOM возникают, когда веб-сайт передает данные из источника в приемник, который затем обрабатывает данные небезопасным способом в контексте сеанса клиента.

Наиболее распространенным источником является URL, доступ к которому обычно осуществляется с помощью locationобъекта. Злоумышленник может создать ссылку, чтобы отправить жертву на уязвимую страницу с полезной нагрузкой в ​​строке запроса и фрагментных частях URL. Рассмотрим следующий код:

goto = location.hash.slice(1)
if (goto.startsWith('https:')) {
  location = goto;
}
Это уязвимо для открытого перенаправления на основе DOM, поскольку location.hashисточник обрабатывается небезопасным способом. Если URL содержит фрагмент хеша, который начинается с https:, этот код извлекает значение свойства location.hashи устанавливает его как locationсвойство window. Злоумышленник может воспользоваться этой уязвимостью, создав следующий URL:

https://www.innocent-website.com/example#https://www.evil-user.net
Когда жертва посещает этот URL, JavaScript устанавливает значение свойства locationна https://www.evil-user.net, что автоматически перенаправляет жертву на вредоносный сайт. Такое поведение может быть легко использовано для создания фишинговой атаки, например.

Общие источники
Ниже приведены типичные источники, которые можно использовать для эксплуатации различных уязвимостей потока зараженных данных:

document.URL
document.documentURI
document.URLUnencoded
document.baseURI
location
document.cookie
document.referrer
window.name
history.pushState
history.replaceState
localStorage
sessionStorage
IndexedDB (mozIndexedDB, webkitIndexedDB, msIndexedDB)
Database
Следующие типы данных также могут использоваться в качестве источников для эксплуатации уязвимостей потока зараженных данных:

Отраженные данные LABS
Сохраненные данные LABS
Веб-сообщения LABS
Какие стоки могут привести к уязвимостям DOM?
Следующий список содержит краткий обзор распространенных уязвимостей на основе DOM и пример стока, который может привести к каждому из них. Для более полного списка соответствующих стоков, пожалуйста, обратитесь к страницам, посвященным уязвимостям, нажав на ссылки ниже.

Уязвимость на основе DOM	Пример раковины
DOM XSS ЛАБОРАТОРИИ	document.write()
Открыть перенаправление LABS	window.location
ЛАБОРАТОРИИ по манипуляциям с файлами cookie	document.cookie
JavaScript-инъекция	eval()
Манипулирование доменом документа	document.domain
Отравление WebSocket-URL	WebSocket()
Манипуляция ссылками	element.src
Манипулирование веб-сообщениями	postMessage()
Манипулирование заголовками запроса Ajax	setRequestHeader()
Локальная манипуляция путями к файлам	FileReader.readAsText()
Клиентская SQL-инъекция	ExecuteSql()
HTML5-манипуляция хранилищем	sessionStorage.setItem()
Внедрение XPath на стороне клиента	document.evaluate()
Клиентская инъекция JSON	JSON.parse()
Манипулирование DOM-данными	element.setAttribute()
Отказ в обслуживании	RegExp()
Как предотвратить уязвимости потока заражения на основе DOM
Не существует единого действия, которое вы можете предпринять, чтобы полностью устранить угрозу атак на основе DOM. Однако, в общем и целом, наиболее эффективный способ избежать уязвимостей на основе DOM — не позволять данным из любого ненадежного источника динамически изменять значение, передаваемое в любой приемник.

Если желаемая функциональность приложения означает, что такое поведение неизбежно, то защита должна быть реализована в клиентском коде. Во многих случаях соответствующие данные могут быть проверены на основе белого списка, разрешая только заведомо безопасный контент. В других случаях необходимо будет очистить или закодировать данные. Это может быть сложной задачей, и в зависимости от контекста, в который должны быть вставлены данные, может включать комбинацию экранирования JavaScript, кодирования HTML и кодирования URL в соответствующей последовательности.

Информацию о мерах, которые вы можете предпринять для предотвращения конкретных уязвимостей, можно найти на соответствующих страницах уязвимостей, ссылки на которые приведены в таблице выше.

DOM затирание
DOM clobbering — это продвинутая техника, при которой вы внедряете HTML в страницу для манипулирования DOM и в конечном итоге изменяете поведение JavaScript на веб-сайте. Наиболее распространенная форма DOM clobbering использует элемент привязки для перезаписи глобальной переменной, которая затем используется приложением небезопасным способом, например, для генерации динамического URL-адреса скрипта.
