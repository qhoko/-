В этом разделе мы опишем межсайтовый скриптинг на основе DOM (DOM XSS), объясним, как найти уязвимости DOM XSS, и поговорим о том, как эксплуатировать DOM XSS с помощью различных источников и приемников.
Что такое межсайтовый скриптинг на основе DOM?
Уязвимости XSS на основе DOM обычно возникают, когда JavaScript берет данные из контролируемого злоумышленником источника, например URL, и передает их в приемник, поддерживающий динамическое выполнение кода, например eval()или innerHTML. Это позволяет злоумышленникам выполнять вредоносный JavaScript, что обычно позволяет им захватывать учетные записи других пользователей.

Чтобы осуществить атаку XSS на основе DOM, необходимо поместить данные в источник так, чтобы они распространились на приемник и вызвали выполнение произвольного JavaScript.

Наиболее распространенным источником DOM XSS является URL, доступ к которому обычно осуществляется с помощью window.locationобъекта. Злоумышленник может создать ссылку, чтобы отправить жертву на уязвимую страницу с полезной нагрузкой в ​​строке запроса и фрагментных частях URL. В определенных обстоятельствах, например, при нацеливании на страницу 404 или веб-сайт, работающий на PHP, полезная нагрузка также может быть размещена в пути.

Подробное описание потока зараженных данных между источниками и приемниками см. на странице уязвимостей на основе DOM .

ТЕстирование HTML-приемников
Чтобы проверить наличие DOM XSS в HTML-приемнике, поместите случайную буквенно-цифровую строку в источник (например, location.search), затем используйте инструменты разработчика, чтобы проверить HTML и найти, где появляется ваша строка. Обратите внимание, что опция браузера «Просмотреть исходный код» не будет работать для тестирования DOM XSS, поскольку она не учитывает изменения, которые были выполнены в HTML с помощью JavaScript. В инструментах разработчика Chrome вы можете использовать Control+F(или Command+Fв MacOS) для поиска вашей строки в DOM.
Для каждого места, где ваша строка появляется в DOM, вам нужно определить контекст. На основе этого контекста вам нужно уточнить свой ввод, чтобы увидеть, как он обрабатывается. Например, если ваша строка появляется в атрибуте, заключенном в двойные кавычки, попробуйте ввести двойные кавычки в вашу строку, чтобы посмотреть, сможете ли вы выйти за пределы атрибута.

Обратите внимание, что браузеры ведут себя по-разному в отношении URL-кодирования: Chrome, Firefox и Safari будут URL-кодировать location.searchи location.hash, тогда как IE11 и Microsoft Edge (до Chromium) не будут URL-кодировать эти источники. Если ваши данные будут URL-кодироваться до обработки, то атака XSS вряд ли сработает.

Тестирование приемников выполнения JavaScript
Тестирование приемников выполнения JavaScript для XSS на основе DOM немного сложнее. С этими приемниками ваш ввод не обязательно появляется где-либо в DOM, поэтому вы не можете его искать. Вместо этого вам нужно будет использовать отладчик JavaScript, чтобы определить, отправляется ли ваш ввод в приемник и как это происходит.

Для каждого потенциального источника, например location, вам сначала нужно найти случаи в коде JavaScript страницы, где ссылаются на источник. В инструментах разработчика Chrome вы можете использовать Control+Shift+F(или Command+Alt+Fна MacOS) для поиска источника по всему коду JavaScript страницы.

После того, как вы нашли, где считывается источник, вы можете использовать отладчик JavaScript, чтобы добавить точку останова и проследить, как используется значение источника. Вы можете обнаружить, что источник назначается другим переменным. Если это так, вам нужно будет снова использовать функцию поиска, чтобы отслеживать эти переменные и смотреть, передаются ли они в приемник. Когда вы найдете приемник, которому назначаются данные, полученные из источника, вы можете использовать отладчик, чтобы проверить значение, наведя курсор на переменную, чтобы увидеть ее значение до того, как оно будет отправлено в приемник. Затем, как и в случае с приемниками HTML, вам нужно будет уточнить свой ввод, чтобы увидеть, сможете ли вы провести успешную атаку XSS.

Тестирование на DOM XSS с использованием DOM Invader
Выявление и эксплуатация DOM XSS в реальных условиях может быть утомительным процессом, часто требующим ручного прочесывания сложного, минимизированного JavaScript. Однако, если вы используете браузер Burp, вы можете воспользоваться его встроенным расширением DOM Invader, которое делает большую часть тяжелой работы за вас.

Читать далее
Документация DOM Invader

Эксплуатация DOM XSS с различными источниками и приемниками
В принципе, веб-сайт уязвим для межсайтового скриптинга на основе DOM, если есть исполняемый путь, по которому данные могут распространяться от источника к приемнику. На практике разные источники и приемники имеют разные свойства и поведение, которые могут влиять на эксплуатируемость и определять, какие методы необходимы. Кроме того, скрипты веб-сайта могут выполнять проверку или другую обработку данных, которые должны быть учтены при попытке эксплуатации уязвимости. Существует множество приемников, которые имеют отношение к уязвимостям на основе DOM. Подробности см. в списке ниже.

Приемник document.writeработает с scriptэлементами, поэтому вы можете использовать простую полезную нагрузку, например, такую, как показано ниже:

document.write('... <script>alert(document.domain)</script> ...');

Лабораторная работа: 01. (Ученик) DOM XSS в document.write приемнике с использованием источника location.search

